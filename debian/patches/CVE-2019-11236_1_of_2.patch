From 9b76785331243689a9d52cef3db05ef7462cb02d Mon Sep 17 00:00:00 2001
From: Ryan Petrello <lists@ryanpetrello.com>
Date: Wed, 1 May 2019 13:11:20 -0400
Subject: [PATCH] Apply fix from CPython for CVE-2019-9740 (#1591)

[rcs: backported to jessie]
--- python-urllib3-jessie.git.orig/test/test_util.py
+++ python-urllib3-jessie.git/test/test_util.py
@@ -128,6 +128,10 @@
     def test_parse_url_invalid_IPv6(self):
         self.assertRaises(ValueError, parse_url, '[::1')
 
+    def test_parse_url_contains_control_characters(self):
+        # see CVE-2019-9740
+        self.assertRaises(LocationParseError, parse_url, 'http://localhost:8000/ HTTP/1.1\r\nHEADER: INJECTED\r\nIgnore:')
+
     def test_request_uri(self):
         url_host_map = {
             'http://google.com/mail': '/mail',
--- python-urllib3-jessie.git.orig/urllib3/util/url.py
+++ python-urllib3-jessie.git/urllib3/util/url.py
@@ -1,10 +1,12 @@
 from collections import namedtuple
+import re
 
 from ..exceptions import LocationParseError
 
 
 url_attrs = ['scheme', 'auth', 'host', 'port', 'path', 'query', 'fragment']
 
+_contains_disallowed_url_pchar_re = re.compile('[\x00-\x20\x7f]')
 
 class Url(namedtuple('Url', url_attrs)):
     """
@@ -100,6 +102,11 @@
         # Empty
         return Url()
 
+    # Prevent CVE-2019-9740.
+    # adapted from https://github.com/python/cpython/pull/12755
+    if _contains_disallowed_url_pchar_re.search(url):
+        raise LocationParseError("URL can't contain control characters. {!r}".format(url))
+
     scheme = None
     auth = None
     host = None
