From efddd7e7bad26188c3b692d1090cba768afa9162 Mon Sep 17 00:00:00 2001
From: Ryan Petrello <lists@ryanpetrello.com>
Date: Thu, 2 May 2019 11:03:09 -0400
Subject: [PATCH] Avoid CVE-2019-9740 in 1.24.x by percent-encoding invalid
 target characters (#1593)

[rcs: backported to jessie]
---
 test/test_util.py   |    9 ++++++++-
 urllib3/util/url.py |    4 ++--
 2 files changed, 10 insertions(+), 3 deletions(-)

--- a/test/test_util.py
+++ b/test/test_util.py
@@ -130,7 +130,14 @@ class TestUtil(unittest.TestCase):
 
     def test_parse_url_contains_control_characters(self):
         # see CVE-2019-9740
-        self.assertRaises(LocationParseError, parse_url, 'http://localhost:8000/ HTTP/1.1\r\nHEADER: INJECTED\r\nIgnore:')
+        url = parse_url('http://localhost/ HTTP/1.1\r\nHEADER: INJECTED\r\nIgnore:')
+        assert url == Url('http', host='localhost', port=None,
+                path='/%20HTTP/1.1%0D%0AHEADER:%20INJECTED%0D%0AIgnore:')
+        url = parse_url(u'http://localhost/ HTTP/1.1\r\nHEADER: INJECTED\r\nIgnore:')
+        assert url == Url('http', host='localhost', port=None,
+                path='/%20HTTP/1.1%0D%0AHEADER:%20INJECTED%0D%0AIgnore:')
+        url = parse_url('http://localhost/ ?q=\r\n')
+        assert url == Url('http', host='localhost', path='/%20', query='q=%0D%0A')
 
     def test_request_uri(self):
         url_host_map = {
--- a/urllib3/util/url.py
+++ b/urllib3/util/url.py
@@ -2,6 +2,7 @@ from collections import namedtuple
 import re
 
 from ..exceptions import LocationParseError
+from six.moves.urllib.parse import quote
 
 
 url_attrs = ['scheme', 'auth', 'host', 'port', 'path', 'query', 'fragment']
@@ -104,8 +105,7 @@ def parse_url(url):
 
     # Prevent CVE-2019-9740.
     # adapted from https://github.com/python/cpython/pull/12755
-    if _contains_disallowed_url_pchar_re.search(url):
-        raise LocationParseError("URL can't contain control characters. {!r}".format(url))
+    url = _contains_disallowed_url_pchar_re.sub(lambda match: quote(match.group()), url)
 
     scheme = None
     auth = None
